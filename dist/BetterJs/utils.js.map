{"version":3,"sources":["BetterJs/utils.js"],"names":["require","_JsonHelper","_interopRequireDefault","_oldWindowError","windowError","isFunction","what","isUndefined","hasKey","object","key","Object","prototype","hasOwnProperty","call","callback","obj","length","i","j","obj1","each","obj2","value","handleWindowError","_window","config","onerror","url","line","col","error","stack","sendError","title","msg","category","objectMerge","JsonHelper","toJson","resourceUrl","rowNum","colNum","apply","window","arguments","handleRejectPromise","addEventListener","event","reason","level","handleResourceError","target","srcElement","HTMLScriptElement","HTMLLinkElement","HTMLImageElement","src","href","nodeName","_handleFetchError","fetch","isElementTarget","res","ok","catch","message","handleAjaxError","location","protocol","xmlhttp","XMLHttpRequest","send","currentTarget","status","responseURL","response","statusText","this","_handleEvent","_oldSend","_oldStateChange_1","handleConsoleError","console","_oldConsoleError"],"mappings":"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","file":"utils.js","sourcesContent":["import \"whatwg-fetch\";\nimport JsonHelper from \"../JsonHelper\";\nvar _oldWindowError = null;\nvar windowError = null;\nfunction isFunction(what) {\n    return typeof what === \"function\";\n}\nfunction isUndefined(what) {\n    return what === void 0;\n}\nfunction hasKey(object, key) {\n    return Object.prototype.hasOwnProperty.call(object, key);\n}\nfunction each(obj, callback) {\n    var i, j;\n    if (isUndefined(obj.length)) {\n        for (i in obj) {\n            if (hasKey(obj, i)) {\n                callback.call(null, i, obj[i]);\n            }\n        }\n    }\n    else {\n        j = obj.length;\n        if (j) {\n            for (i = 0; i < j; i++) {\n                callback.call(null, i, obj[i]);\n            }\n        }\n    }\n}\nfunction objectMerge(obj1, obj2) {\n    if (!obj2) {\n        return obj1;\n    }\n    each(obj2, function (key, value) {\n        obj1[key] = value;\n    });\n    return obj1;\n}\nvar handleWindowError = function (_window, config) {\n    _oldWindowError = _window.onerror;\n    _window.onerror = function (msg, url, line, col, error) {\n        if (error && error.stack) {\n            config.sendError({\n                title: msg,\n                msg: error.stack,\n                category: \"js\",\n                level: \"error\"\n            });\n        }\n        else if (typeof msg === \"string\") {\n            config.sendError({\n                title: msg,\n                msg: JsonHelper.toJson({\n                    resourceUrl: url,\n                    rowNum: line,\n                    colNum: col\n                }),\n                category: \"js\",\n                level: \"error\"\n            });\n        }\n        if (_oldWindowError && isFunction(_oldWindowError)) {\n            if (windowError)\n                windowError.apply(window, arguments);\n        }\n    };\n};\nvar handleRejectPromise = function (_window, config) {\n    _window.addEventListener(\"unhandledrejection\", function (event) {\n        if (event) {\n            var reason = event.reason;\n            config.sendError({\n                title: \"unhandledrejection\",\n                msg: reason,\n                category: \"js\",\n                level: \"error\"\n            });\n        }\n    }, true);\n};\nvar handleResourceError = function (_window, config) {\n    _window.addEventListener(\"error\", function (event) {\n        if (event) {\n            var target = event.target || event.srcElement;\n            var isElementTarget = target instanceof HTMLScriptElement ||\n                target instanceof HTMLLinkElement ||\n                target instanceof HTMLImageElement;\n            if (!isElementTarget)\n                return; // js error不再处理\n            var url = target.src || target.href;\n            config.sendError({\n                title: target.nodeName,\n                msg: url,\n                category: \"resource\",\n                level: \"error\"\n            });\n        }\n    }, true);\n};\nvar _handleFetchError = function (_window, config) {\n    if (!_window.fetch)\n        return;\n    var _oldFetch = _window.fetch;\n    _window.fetch = function () {\n        return _oldFetch\n            .apply(this, arguments)\n            .then(function (res) {\n            if (!res.ok) {\n                // True if status is HTTP 2xx\n                config.sendError({\n                    title: arguments[0],\n                    msg: JsonHelper.toJson(res),\n                    category: \"ajax\",\n                    level: \"error\"\n                });\n            }\n            return res;\n        })\n            .catch(function (error) {\n            config.sendError({\n                title: arguments[0],\n                msg: JsonHelper.toJson({\n                    message: error.message,\n                    stack: error.stack\n                }),\n                category: \"ajax\",\n                level: \"error\"\n            });\n            throw error;\n        });\n    };\n};\nvar handleAjaxError = function (_window, config) {\n    var protocol = _window.location.protocol;\n    if (protocol === \"file:\")\n        return;\n    // 处理fetch\n    _handleFetchError(_window, config);\n    // 处理XMLHttpRequest\n    if (!_window.XMLHttpRequest) {\n        return;\n    }\n    var xmlhttp = _window.XMLHttpRequest;\n    var _oldSend = xmlhttp.prototype.send;\n    var _handleEvent = function (event) {\n        if (event && event.currentTarget && event.currentTarget.status !== 200) {\n            config.sendError({\n                title: event.target.responseURL,\n                msg: JsonHelper.toJson({\n                    response: event.target.response,\n                    responseURL: event.target.responseURL,\n                    status: event.target.status,\n                    statusText: event.target.statusText\n                }),\n                category: \"ajax\",\n                level: \"error\"\n            });\n        }\n    };\n    xmlhttp.prototype.send = function () {\n        if (this[\"addEventListener\"]) {\n            this[\"addEventListener\"](\"error\", _handleEvent);\n            this[\"addEventListener\"](\"load\", _handleEvent);\n            this[\"addEventListener\"](\"abort\", _handleEvent);\n        }\n        else {\n            var _oldStateChange_1 = this[\"onreadystatechange\"];\n            this[\"onreadystatechange\"] = function (event) {\n                if (this.readyState === 4) {\n                    _handleEvent(event);\n                }\n                if (_oldStateChange_1)\n                    _oldStateChange_1.apply(this, arguments);\n            };\n        }\n        return _oldSend.apply(this, arguments);\n    };\n};\nvar handleConsoleError = function (_window, config) {\n    if (!_window.console || !_window.console.error)\n        return;\n    var _oldConsoleError = _window.console.error;\n    _window.console.error = function () {\n        config.sendError({\n            title: \"consoleError\",\n            msg: JsonHelper.toJson(arguments),\n            category: \"js\",\n            level: \"error\"\n        });\n        if (_oldConsoleError)\n            _oldConsoleError.apply(_window, arguments);\n    };\n};\nexport default {\n    isFunction: isFunction,\n    objectMerge: objectMerge,\n    handleWindowError: handleWindowError,\n    handleRejectPromise: handleRejectPromise,\n    handleConsoleError: handleConsoleError,\n    handleResourceError: handleResourceError,\n    handleAjaxError: handleAjaxError\n};\n"]}