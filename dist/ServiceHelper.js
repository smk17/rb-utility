"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("whatwg-fetch");var _moment=_interopRequireDefault(require("moment")),_IUtilityTypes=require("./IUtilityTypes"),_JsonHelper=_interopRequireDefault(require("./JsonHelper")),_ConsoleHelper=_interopRequireDefault(require("./ConsoleHelper")),_EventDriver=_interopRequireDefault(require("./EventDriver"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var __awaiter=function(i,a,s,u){return new(s||(s=Promise))(function(e,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function n(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,n)}o((u=u.apply(i,a||[])).next())})},__generator=function(r,n){var o,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=void 0,ServiceHelper=function(){function _(){}return _._dispose=function(e,t){if(e)switch(e.name){case"PassException":return;case"BusinessException":switch(e.errorType=_IUtilityTypes.ErrorType.business,e.type){case"ReferencedDataException":var r=e.referencedDatas;5<r.length&&(r[5]="等"),e.success=!1,e.message="被使用的数据："+r.join("，")+e.message,t&&t(e);break;default:e.success=!1,t&&t(e)}break;case"RightsException":case"SystemException":case"AuthorizationException":case"ClientDisposeException":case"OpenDBConnectionException":e.success=!1,t&&t(e);break;default:var n=e+"";if(n.search("Network request failed")){var o={name:"RequestServiceException",status:704,message:"网络请求失败，错误码：704"};t&&t(o)}else{o={success:!1,message:n};t&&t(o)}}},_._executeService=function(d,m){var e=this;return new Promise(function(p,y){return __awaiter(e,void 0,void 0,function(){var t,r,n,o,i,a,s,u,c,l,f;return __generator(this,function(e){switch(e.label){case 0:return r=!1,n=m.handlingErrorLevel||_IUtilityTypes.ServiceErrorLevelEnum.allError,m.params?m.params instanceof FormData?(t=m.params,r=!0,[3,7]):[3,1]:[3,7];case 1:for(i in e.trys.push([1,6,,7]),t="",o=[],m.params)o.push(i);a=0,e.label=2;case 2:return a<o.length?(s=o[a],m.params.hasOwnProperty(s)?(t&&(t+="&"),u=t,c=s+"=",[4,_._toParamString(m.params[s])]):[3,4]):[3,5];case 3:t=u+(c+e.sent()),e.label=4;case 4:return a++,[3,2];case 5:return[3,7];case 6:return l=e.sent(),n>=_IUtilityTypes.ServiceErrorLevelEnum.fail?(_ConsoleHelper.default.warn("FormatError"),_._dispose(l,y),_ConsoleHelper.default.error("FormData format error: "+l)):y({type:"FormatError",name:"参数格式化出错，请检查参数格式",message:l}),[3,7];case 7:return f=new Headers({"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"}),r||(f["Content-Type"]="application/x-www-form-urlencoded"),Promise.race([fetch(d+m.name,{method:"POST",cache:"no-cache",credentials:"include",headers:f,body:t}),new Promise(function(e,t){setTimeout(function(){t({success:!1,message:"网络请求超时啦～"})},_.TIMEOUT)})]).then(function(e){var t;if(e){if(200<=e.status&&e.status<300)return e.text();throw(t=new Error(e.statusText)).name="RequestServiceException",t.status=e.status,t}throw(t=new Error("response is null")).name="RequestNullException",t}).then(function(e){var t=_JsonHelper.default.parseJson(e);if(_.development&&_ConsoleHelper.default.log(t),"/anonymity/writelog"!==m.name){var r=t.e;r?(r.name,n>=_IUtilityTypes.ServiceErrorLevelEnum.allError&&_._dispose(r,y),y(r)):t.data?!1===t.data.success?y(t.data):p(t.data):(_ConsoleHelper.default.error(m.name,"获取数据为null"),p(void 0))}}).catch(function(e){"/anonymity/writelog"!==m.name&&(n>=_IUtilityTypes.ServiceErrorLevelEnum.fail?_._dispose(e,y):y(e))}),[2]}})})})},_.writeLog=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return _ConsoleHelper.default.log(_JsonHelper.default.toJson(t),"@dy/service/ServiceHelper.ts:239"),[2]})})},_.executeService=function(e,i,a){return void 0===a&&(a=_IUtilityTypes.ServiceType.Get),new Promise(function(r,n){var o=_.RELOADCOUNT;!function t(){_._executeService(e,i).then(function(e){r(e),a===_IUtilityTypes.ServiceType.Get&&_EventDriver.default.send("networkError",!1,function(){})}).catch(function(e){!1!==e.success?_.development?n(e):"RequestServiceException"!==e.name||408!==e.status&&503!==e.status&&504!==e.status&&704!==e.status?n(e):0<o?(_ConsoleHelper.default.log("数据请求失败，重新请求，请求计数："+o,"@dy/service/ServiceHelper.ts:273"),t(),o--):(a===_IUtilityTypes.ServiceType.Get&&_EventDriver.default.send("networkError",!0,t),n(e)):n(e)})}()})},_.RELOADCOUNT=5,_.TIMEOUT=3e4,_.development=!1,_._toParamString=function(r){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){if(null==r)return[2,null];switch(_typeof(r)){case"string":return[2,r];case"boolean":return[2,r?"true":"false"];case"number":return[2,r.toString()];default:if(_moment.default.isDate(r))return[2,(0,_moment.default)(r).format("yyyy-MM-dd HH:mm:ss")];if(r.data&&r.data instanceof Blob&&"string"==typeof r.fileName)return[2,r];if("object"===_typeof(r))for(t in r)r.hasOwnProperty(t)&&"object"===_typeof(r[t])&&(r[t]=_JsonHelper.default.toJson(r[t]));return[2,_JsonHelper.default.toJson(r)]}return[2]})})},_}(),_default=ServiceHelper;exports.default=_default;
//# sourceMappingURL=ServiceHelper.js.map
