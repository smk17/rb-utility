"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _NumberHelper=_interopRequireDefault(require("./NumberHelper")),_ErrorHelper=_interopRequireDefault(require("./ErrorHelper")),_TypeHelper=_interopRequireDefault(require("./TypeHelper"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var DataManager=function(){function e(e,r){this._data=e,r&&(this._addition=r)}return e.prototype.getValue=function(e){var r=this._data[e];return void 0===r&&this._addition&&(r=this._addition[e]),_NumberHelper.default.parse(r)},e}(),Formula=function(){function p(e,r){void 0===r&&(r=2);var a=[];_TypeHelper.default.isNumber(r)?r<0&&(r=0):r=2,this._fn=new Function("data","NumberHelper","return NumberHelper.round("+p._replaceSymbel(e).replace(p._formulaRegular,function(e,r,t){return a.indexOf(t)<0&&a.push(t),r?r+'data.getValue("'+t+'")':'data.getValue("'+t+'")'})+","+r+")"),this._partake=a}return p._getFormulaValue=function(e,r,t){var a,u,l,n,i=e.length,o=0,s="",d=-1;for(u=r;u<i;u++)if(a=e.charAt(u),n)n===a&&(n=null);else switch(a){case"(":1===++o&&(d=u,s+=e.substring(r,u+1));break;case")":if(--o<0)throw _ErrorHelper.default.create("FormulaInvalid","当前提供的公式字符串无效。");0===o&&(s+=p._replaceSymbel(e.substring(d+1,u))+")",r=u+1);break;case"+":case"-":if(0===o)return r<u&&(s+=e.substring(r,u)),{value:s.trim(),nextIndex:u+1,symbolValue:a};break;case"*":case"/":if(0===o)return r<u&&(s+=e.substring(r,u)),1===t?{value:s.trim(),nextIndex:u+1,symbolValue:a}:(l=p._getFormulaValue(e,u+1,1),{value:(s="NumberHelper.calculate("+s.trim()+","+l.value+",'"+a+"')").trim(),nextIndex:l.nextIndex,symbolValue:l.symbol});break;case",":if(0===o)return r<u&&(s+=e.substring(r,u)),{value:s.trim(),nextIndex:u+1,symbolValue:a};break;case'"':case"'":n=a;break;case" ":r===u&&r++}return r<i&&(s+=e.substr(r)),{value:s.trim(),nextIndex:i}},p._replaceSymbel=function(e){if(!(e=e.trim()))return"";var r,t,a=e.length,u=p._getFormulaValue(e,0,1);if(u.nextIndex===a)return u.value;t=u.value;do{if(","===(r=u.symbolValue))return t+","+p._replaceSymbel(e.substr(u.nextIndex));t="NumberHelper.calculate("+t+",",t+=(u=p._getFormulaValue(e,u.nextIndex,"+"===r||"-"===r?0:1)).value+",'"+r+"')"}while(u.nextIndex<a);return t},p.prototype.calc=function(e,r){return this._fn(new DataManager(e,r),_NumberHelper.default)},p.prototype.getPartake=function(){return this._partake},p._formulaRegular=new RegExp("([^a-zA-Z0-9]|^)data.([a-zA-Z0-9_]+)","g"),p}(),_default=Formula;exports.default=_default;
//# sourceMappingURL=Formula.js.map
