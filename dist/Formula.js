"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _NumberHelper=_interopRequireDefault(require("./NumberHelper")),_ErrorHelper=_interopRequireDefault(require("./ErrorHelper")),_TypeHelper=_interopRequireDefault(require("./TypeHelper"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var a=0;a<r.length;a++){var t=r[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,r,a){return r&&_defineProperties(e.prototype,r),a&&_defineProperties(e,a),e}var DataManager=function(){function a(e,r){_classCallCheck(this,a),this._data=e,r&&(this._addition=r)}return _createClass(a,[{key:"getValue",value:function(e){var r=this._data[e];return void 0===r&&this._addition&&(r=this._addition[e]),_NumberHelper.default.parse(r)}}]),a}(),Formula=function(){function f(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:2;_classCallCheck(this,f);var t=[];_TypeHelper.default.isNumber(r)?r<0&&(r=0):r=2,this._fn=new Function("data","NumberHelper","return NumberHelper.round("+f._replaceSymbel(e).replace(f._formulaRegular,function(e,r,a){return t.indexOf(a)<0&&t.push(a),r?r+'data.getValue("'+a+'")':'data.getValue("'+a+'")'})+","+r+")"),this._partake=t}return _createClass(f,[{key:"calc",value:function(e,r){return this._fn(new DataManager(e,r),_NumberHelper.default)}},{key:"getPartake",value:function(){return this._partake}}],[{key:"_getFormulaValue",value:function(e,r,a){var t,u,l,n,i=e.length,s=0,o="",c=-1;for(u=r;u<i;u++)if(t=e.charAt(u),n)n===t&&(n=null);else switch(t){case"(":1===++s&&(c=u,o+=e.substring(r,u+1));break;case")":if(--s<0)throw _ErrorHelper.default.create("FormulaInvalid","当前提供的公式字符串无效。");0===s&&(o+=f._replaceSymbel(e.substring(c+1,u))+")",r=u+1);break;case"+":case"-":if(0===s)return r<u&&(o+=e.substring(r,u)),{value:o.trim(),nextIndex:u+1,symbolValue:t};break;case"*":case"/":if(0===s)return r<u&&(o+=e.substring(r,u)),1===a?{value:o.trim(),nextIndex:u+1,symbolValue:t}:(l=f._getFormulaValue(e,u+1,1),{value:(o="NumberHelper.calculate("+o.trim()+","+l.value+",'"+t+"')").trim(),nextIndex:l.nextIndex,symbolValue:l.symbol});break;case",":if(0===s)return r<u&&(o+=e.substring(r,u)),{value:o.trim(),nextIndex:u+1,symbolValue:t};break;case'"':case"'":n=t;break;case" ":r===u&&r++}return r<i&&(o+=e.substr(r)),{value:o.trim(),nextIndex:i}}},{key:"_replaceSymbel",value:function(e){if(!(e=e.trim()))return"";var r,a,t=e.length,u=f._getFormulaValue(e,0,1);if(u.nextIndex===t)return u.value;a=u.value;do{if(","===(r=u.symbolValue))return a+","+f._replaceSymbel(e.substr(u.nextIndex));a="NumberHelper.calculate("+a+",",a+=(u=f._getFormulaValue(e,u.nextIndex,"+"===r||"-"===r?0:1)).value+",'"+r+"')"}while(u.nextIndex<t);return a}}]),f}();(exports.default=Formula)._formulaRegular=new RegExp("([^a-zA-Z0-9]|^)data.([a-zA-Z0-9_]+)","g");
//# sourceMappingURL=Formula.js.map
